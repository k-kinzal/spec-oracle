# PROBLEM.md

## 目的

このファイルは、spec-oracleツールを使用する中で発見された問題を記録します。
問題は、実装上のバグ、使いにくさ、設計上の問題、仕様の不備などを含みます。

## 運用方法

- ユーザーまたは開発者が問題に気づいたら、このファイルに追記する
- 問題は優先度順に並べる（Critical > High > Medium > Low）
- 問題が解決されたら、チェックボックスにチェックを入れる
- 解決策や関連する変更へのリンクを記載する
- 定期的にチェック済みの古い問題を削除またはアーカイブする

## フォーマット

```markdown
- [ ] **[優先度] 問題の概要**
  - **発見日**: YYYY-MM-DD
  - **詳細**: 問題の詳しい説明
  - **再現手順**: （該当する場合）
  - **影響範囲**: どの機能/ユーザーに影響するか
  - **解決策案**: （あれば）
  - **解決状況**: 未着手/調査中/実装中/完了
```

---

## 未解決の問題

### Critical

- [ ] **specコマンドが低レベルすぎて使えない（node/edgeの抽象化漏れ）**
  - **発見日**: 2026-02-14
  - **詳細**: 現在のspecコマンドは`add-node`, `list-nodes`, `add-edge`, `list-edges`など、完全にグラフデータベースの低レベルAPIを露出している。ユーザーは「nodeって何？」という状態で、仕様管理というユースケースが見えない。
  - **現状の問題**:
    - `spec add-node "パスワードは8文字以上" --kind constraint` ← ユーザーはkindを理解する必要がある
    - `spec add-edge <source-id> <target-id> --kind refines` ← UUIDとedge kindを管理する必要がある
    - 機能が多すぎて（30個以上のサブコマンド）何をすればいいか分からない
  - **あるべき姿**:
    - **ユースケース指向のコマンド**:
      - `spec add "パスワードは8文字以上"` → 内部でnode/kind/関係を推論
      - `spec check` → 矛盾と漏れを両方チェック
      - `spec find "認証"` → 関連仕様を検索
      - `spec trace "パスワード検証"` → その仕様の全層を表示
    - **低レベルAPIは別名前空間に**:
      - `spec api add-node ...`
      - `spec api add-edge ...`
      - 内部詳細が必要な場合のみ使用
  - **影響範囲**: ツール全体のユーザビリティ。現状では一般ユーザーが使えない。
  - **解決策案**:
    - specコマンドのサブコマンドを再設計
    - ユースケースベースのコマンド体系を構築
    - 低レベルAPIは`spec api`または`spec-admin`など別コマンドに分離
    - コマンド数を10個以下に削減
  - **解決状況**: 未着手

- [ ] **specコマンドが応答せず、直接JSON操作が必要**
  - **発見日**: 2026-02-14
  - **詳細**: `spec list-nodes`などのコマンドがバックグラウンドで実行されてしまい、直接結果を得られない。結果として、`~/spec-oracle/specs.json`を直接jqで解析する必要がある。
  - **再現手順**:
    1. `specd`サーバーを起動
    2. `./target/release/spec list-nodes`を実行
    3. コマンドがバックグラウンドタスクとして実行され、即座に結果が返らない
  - **影響範囲**: すべてのspecコマンドのCLI操作が困難。仕様の確認や問い合わせに支障。
  - **解決策案**:
    - gRPC接続の問題を調査（タイムアウト、ポート、アドレス設定）
    - `spec`コマンドの同期実行ロジックを確認
    - エラーハンドリングとログ出力の改善
  - **解決状況**: 未着手

- [ ] **U0層とU3層の間にformalizes/transformエッジが作成されていない**
  - **発見日**: 2026-02-14
  - **詳細**: 自然言語仕様（U0）と実行可能コード仕様（U3）は意味的に同じ要求を表現しているが、グラフ上で`formalizes`や`transform`エッジによって接続されていない。これにより、多層仕様の追跡と整合性検証ができない。
  - **具体例**:
    - U0: "Server must detect specification omissions" (id: b18aad55-5290-4327-8686-8b520987e204)
    - U3: "Invariant: omissions.iter().any(...)" (id: cd8cd613-be8b-4c83-a265-f441a113b3cb)
    - これらの間に関係性なし
  - **影響範囲**: 多層仕様管理の核心機能が機能していない。conversation.mdで議論されたU/D/A/fモデルのf（変換関数）が実装されていない。
  - **解決策案**:
    - `extract`コマンド実行時に、自動的にformalizes関係を推論・作成
    - `infer-relationships-ai`コマンドでformalizes関係も推論
    - 手動でformalizes関係を作成するUIコマンドを追加
  - **解決状況**: 未着手

- [ ] **矛盾検出が重複仕様を検出しない**
  - **発見日**: 2026-02-14
  - **詳細**: `detect-contradictions`コマンドが「No contradictions detected」と報告するが、実際には同じドメインが2つずつ、同じInvariantが4つ以上存在している。
  - **再現手順**:
    1. `spec list-nodes --kind domain` → Architecture, Communication, Storage, Analysisが2回ずつ
    2. `spec query "omission"` → 同じInvariantが4回以上
    3. `spec detect-contradictions` → 矛盾なしと報告
  - **影響範囲**: 矛盾検出機能が信頼できない。データ品質管理ができない。
  - **解決策案**:
    - 同一内容の重複を検出するロジックを追加
    - 同一ドメイン名の重複を検出
    - 意味的に同じ仕様の重複を検出（AI活用）
  - **解決状況**: 未着手

- [ ] **大量の重複仕様が存在する（データ品質問題）**
  - **発見日**: 2026-02-14
  - **詳細**: ドメイン、Invariant、Scenarioが大量に重複登録されている。
    - ドメイン: Architecture, Communication, Storage, Analysisが各2個
    - Invariant: 同じ内容が4個以上（例：`omissions.iter().any(|o| o.description.contains("Isolated"))`）
    - Scenario: 同じテストが2個以上
  - **影響範囲**: データの信頼性が低い。検索結果が冗長。
  - **解決策案**:
    - 重複データのクリーンアップスクリプト
    - extractコマンド実行時に既存仕様との重複チェック
    - マージ機能（重複仕様を統合）
  - **解決状況**: 未着手

### High

- [ ] **U1層（形式仕様）とU2層（インターフェース定義）の仕様が欠落**
  - **発見日**: 2026-02-14
  - **詳細**: 主要な仕様（omission検出など）について、U0（自然言語）とU3（コード）の間の中間層が記録されていない。
    - U1: TLA+、Alloy、形式モデルなど
    - U2: gRPC proto定義、API仕様、型定義など
  - **影響範囲**: 完全な多層仕様追跡ができない。設計から実装への変換過程が不可視。
  - **解決策案**:
    - protoファイルからU2層仕様を抽出する機能を追加
    - 手動でU1/U2層仕様を登録できるコマンドを追加
    - formality_layerの自動推論を改善
  - **解決状況**: 未着手

- [ ] **formality_layerの二重管理**
  - **発見日**: 2026-02-14
  - **詳細**: ノード構造の`formality_layer`フィールドと`metadata.formality_layer`が両方存在し、実際の層情報はmetadataに文字列として記録されている。ノード自体のformality_layerは常に0のまま。
  - **影響範囲**: データモデルの一貫性がない。クエリが複雑になる。
  - **解決策案**:
    - `formality_layer`フィールドを正しく更新するようにextractorを修正
    - または、metadataのみを使用し、ノードフィールドを削除
    - データマイグレーションスクリプトを作成
  - **解決状況**: 未着手

- [ ] **list-nodesが大量の結果を一気に表示する**
  - **発見日**: 2026-02-14
  - **詳細**: `spec list-nodes`を実行すると577個のノードが一気に表示される。多すぎて把握できない。
  - **影響範囲**: プロジェクトの仕様全体を把握できない。
  - **解決策案**:
    - デフォルトで要約表示（ドメインごとの件数など）
    - ページネーション（`--limit`, `--offset`）
    - インタラクティブモード（fzfのような選択UI）
    - `spec summary`コマンドで概要を表示
  - **解決状況**: 未着手

- [ ] **検索結果に層情報が表示されない**
  - **発見日**: 2026-02-14
  - **詳細**: `spec query "omission"`で24件ヒットするが、自然言語仕様（U0）とコード仕様（U3）が混在していて区別できない。
  - **影響範囲**: どの層の仕様か分からず、混乱する。
  - **解決策案**:
    - 出力に`[U0]`, `[U3]`などの層ラベルを追加
    - `--layer <N>`オプションで層を絞り込み
    - 層ごとにグループ化して表示
  - **解決状況**: 未着手

- [ ] **get-nodeの出力情報が少なすぎる**
  - **発見日**: 2026-02-14
  - **詳細**: `spec get-node <id>`がContentとKindしか表示しない。formality_layer、metadata、関連ノード、作成日時などが見えない。
  - **影響範囲**: ノードの詳細情報を得られない。
  - **解決策案**:
    - 全フィールドを表示（layer, metadata, timestamps）
    - 関連ノードも一緒に表示（incoming/outgoing edges）
    - `--verbose`フラグで詳細表示
  - **解決状況**: 未着手

- [ ] **list-edgesがUUIDしか表示せず、内容が分からない**
  - **発見日**: 2026-02-14
  - **詳細**: `spec list-edges --node <id>`でエッジが表示されるが、UUIDのみで、ノードの内容が分からない。
  - **再現手順**:
    1. `spec list-edges --node b18aad55-5290-4327-8686-8b520987e204`
    2. `bf71989b... --[refines]--> b18aad55...`と表示される
    3. UUIDだけでは何のノードか分からない
  - **影響範囲**: エッジを理解するために、各UUIDで`get-node`を実行する必要がある。
  - **解決策案**:
    - ノードの内容も一緒に表示
    - `[scenario] System identifies isolated nodes --[refines]--> [constraint] Server must detect omissions`
  - **解決状況**: 未着手

- [ ] **関連仕様を階層的に表示するコマンドがない**
  - **発見日**: 2026-02-14
  - **詳細**: 特定の仕様に関連する全ノード（refines, formalizes関係）を一度に見るコマンドがない。UUIDごとに`get-node`を何度も実行する必要がある。
  - **影響範囲**: 仕様の全体像を把握するのに時間がかかる。
  - **解決策案**:
    - `spec trace <id>`コマンド（関連ノードをツリー表示）
    - `spec show <id> --with-related`（詳細+関連ノード）
  - **解決状況**: 未着手

### Medium

- [ ] **漏れ検出が過剰報告する（169個）**
  - **発見日**: 2026-02-14
  - **詳細**: `spec detect-omissions`が169個の漏れを報告するが、多すぎて対処できない。また、明らかに関連している仕様（"Passwords must be at least 8 characters"と"Invariant: password.len() >= 8"）が孤立として報告される。
  - **影響範囲**: 漏れ検出が実用的でない。
  - **解決策案**:
    - 重要度スコアリング（優先度の高い漏れを先に表示）
    - `--critical-only`フラグ（重大な漏れのみ）
    - 関係推論の改善（意味的に関連する仕様を自動接続）
  - **解決状況**: 未着手

- [ ] **specコマンドのレスポンスが遅い/タイムアウトする**
  - **発見日**: 2026-02-14
  - **詳細**: `spec list-edges --node <id>`などのコマンドが完了しない。
  - **影響範囲**: 仕様の探索とデバッグが困難。
  - **解決策案**: gRPCのタイムアウト設定、サーバー側のパフォーマンス最適化
  - **解決状況**: 未着手

- [ ] **CLIの出力フォーマットが人間に読みにくい**
  - **発見日**: 2026-02-14
  - **詳細**: 仕様の内容を確認するために、結局jqで整形する必要がある。CLIの出力が構造化されていない、または読みにくい。
  - **影響範囲**: ユーザビリティ
  - **解決策案**:
    - 表形式出力（tableフォーマット）を追加
    - `--format json|table|tree`オプションを追加
    - デフォルトで人間が読みやすい形式にする
  - **解決状況**: 未着手

- [ ] **仕様の多層構造を可視化するコマンドがない**
  - **発見日**: 2026-02-14
  - **詳細**: 特定の仕様（例：omission検出）のU0からU3までの全層を一覧表示するコマンドがない。
  - **影響範囲**: 多層仕様の理解が困難。
  - **解決策案**:
    - `spec trace <node-id>`コマンドを追加（formalizes/transform関係を辿って全層を表示）
    - `spec layers <query>`コマンドで、特定トピックの全層仕様を表示
  - **解決状況**: 未着手

### Low

- [ ] **READMEとCLIヘルプの情報が不足**
  - **発見日**: 2026-02-14
  - **詳細**: 多層仕様管理の使い方、formality_layerの意味、formalizes/transform関係の説明が不足。
  - **影響範囲**: ユーザーが機能を理解できない
  - **解決策案**: ドキュメント整備、チュートリアル追加
  - **解決状況**: 未着手

---

## 解決済みの問題

（まだありません）

---

## アーカイブ

（古い解決済み問題をここに移動します）
