# SPARK/Adaの産業応用

## 概要

SPARK（SPARK Ada）は、Ada言語のサブセットとして設計された形式検証可能なプログラミング言語である。1980年代後半にBernard Carré率いるPraxis社（現Altran Praxis）のチームによって開発され、安全性が極めて重要なシステムの開発において、実行時エラーの完全な排除を目指している。SPARKは単なるプログラミング言語ではなく、契約ベースの形式仕様、静的解析ツール（GNATprove）、形式的検証手法を統合したエコシステム全体を指す。

SPARKの設計哲学は「ゼロ欠陥開発」（zero-defect development）にある。これは、実行前にプログラムの正しさを数学的に証明することで、配列境界オーバーラン、ヌルポインタ参照、整数オーバーフロー、未初期化変数の使用といった一般的なプログラミングエラーを完全に排除することを意味する。この目標を達成するため、SPARKはAdaの動的で予測困難な機能（ポインタの自由な操作、例外処理、動的メモリ割り当て、タスキングなど）を制限している。

## SPARKの言語設計とAda契約システム

### Adaの契約機能

Ada 2012から導入された契約ベースプログラミング（Design by Contract）の機能は、SPARKの形式検証の基盤となっている。主要な契約構造には以下のものがある：

**Pre条件とPost条件**
```ada
procedure Transfer(From, To : in out Account; Amount : Natural)
  with Pre  => From.Balance >= Amount and then To.Balance <= Natural'Last - Amount,
       Post => From.Balance = From.Balance'Old - Amount and then
               To.Balance = To.Balance'Old + Amount;
```

この例では、Pre条件が送金元の残高が十分であること、送金先の口座がオーバーフローしないことを保証し、Post条件が正確に指定された金額が転送されたことを検証する。`'Old`属性は、サブプログラム呼び出し前の値を参照するために使用される。

**Type_Invariant**
```ada
type Stack is private
  with Type_Invariant => Is_Valid(Stack);

function Is_Valid(S : Stack) return Boolean is
  (S.Top in 0 .. S.Max_Size and then
   (for all I in 1 .. S.Top => S.Elements(I) /= 0));
```

型不変条件は、データ型のすべての操作において維持されるべき性質を指定する。これにより、データ構造の整合性がプログラム全体を通じて保証される。

**Contract_Cases**
```ada
procedure Process(Input : Integer; Result : out Status)
  with Contract_Cases =>
    (Input < 0     => Result = Error,
     Input = 0     => Result = Empty,
     Input > 0 and Input <= 100 => Result = Valid,
     Input > 100   => Result = Overflow);
```

Contract_Casesは、入力条件ごとに異なる事後条件を指定する強力な機能である。これにより、複雑な条件分岐の仕様を明確に表現できる。

### GNATproveによる形式検証

GNATproveは、AdaCoreが開発したSPARKプログラムの静的解析および形式検証ツールである。Why3形式検証プラットフォームと、Alt-Ergo、CVC4、Z3などのSMTソルバーを統合している。GNATproveは複数の検証レベルを提供する：

**Stone Level（Flow Analysis）**
- データ依存関係の解析
- 未初期化変数の検出
- 使用されていない変数や代入の検出
- グローバル変数の使用パターンの検証

**Bronze Level（AoRTE - Absence of Run-Time Errors）**
- 配列インデックスの境界チェック
- 整数オーバーフロー/アンダーフローの検証
- 除算ゼロエラーの排除
- 型変換の安全性検証

**Silver Level（Contract Verification）**
- Pre条件とPost条件の検証
- Type_Invariantの維持確認
- Contract_Casesの網羅性と正しさの検証

**Gold Level（Complete Functional Correctness）**
- プログラムの完全な関数的正しさの証明
- すべての契約とアサーションの検証
- ループ不変条件の証明

GNATproveは証明の自動化を目指しているが、複雑なロジックについてはユーザーがループ不変条件やアサーションを追加して証明を支援する必要がある。

## 航空宇宙分野での応用

### DO-178C認証

航空宇宙産業において、SPARKは特にDO-178C（航空機搭載ソフトウェアの認証基準）の文脈で重要な役割を果たしている。DO-178Cは、2011年に発行されたDO-178Bの後継規格であり、形式手法の使用を明示的にサポートするサプリメント（DO-333）を含んでいる。

SPARKとGNATproveの組み合わせは、DO-178Cの以下の目標達成を支援する：

1. **構造カバレッジの簡素化**: 形式検証により、コードのすべてのパスが解析されるため、一部のテストケースを削減できる可能性がある。

2. **要求ベースのテストの補完**: Pre/Post条件は要求仕様を形式化したものであり、これらの証明は要求に対する適合性の検証となる。

3. **リバースエンジニアリングの削減**: 契約により、コードの意図が明確に記述されるため、コードレビューの効率が向上する。

### 実際の航空宇宙プロジェクト

**Rockwell Collins社の飛行制御システム**
Rockwell Collins社は、無人航空機（UAV）の飛行制御ソフトウェアの一部にSPARKを採用した。特に、センサーデータ処理とナビゲーションアルゴリズムの実装において、GNATproveによる実行時エラーの完全排除を達成した。このプロジェクトでは、従来のテストベース検証と比較して、検証コストを約40%削減したと報告されている。

**Thales社の航空電子機器**
Thales社は、商用航空機の航空電子機器ソフトウェアにSPARKを使用している。特に、フライト管理システム（FMS）の一部コンポーネントがSPARKで実装されており、DO-178C Level Aの認証を取得している。

**欧州宇宙機関（ESA）のプロジェクト**
ESAは、宇宙機の姿勢制御システムや地上管制システムの一部でSPARKを評価・採用している。宇宙環境での放射線によるビット反転エラーのリスクを考慮すると、ソフトウェア自体のバグを排除することの価値は極めて高い。

## 鉄道分野での応用

### CENELEC EN 50128規格

鉄道産業では、CENELEC EN 50128が鉄道制御・保護システムのソフトウェアの安全性基準を定めている。この規格は、ソフトウェア安全度水準（SIL: Safety Integrity Level）を0から4まで定義しており、最高レベルのSIL 4では形式手法の使用が「強く推奨」（Highly Recommended）されている。

SPARKとGNATproveは、EN 50128の以下の要件を満たすために使用される：

- **表A.3（ソフトウェア設計と実装技法）**: 形式手法、防御的プログラミング、強い型付け
- **表A.13（ソフトウェア検証と妥当性確認）**: 静的解析、形式的証明

### 実際の鉄道プロジェクト

**Thales社の列車制御システム**
Thales社は、ERTMS（European Rail Traffic Management System）Level 2の車上制御装置（OBU: On-Board Unit）の一部をSPARKで実装している。この装置は、列車の位置、速度、移動権限を管理する安全上重要なシステムであり、SIL 4の認証が要求される。

SPARKの採用により、以下の成果が報告されている：
- 実行時エラーのゼロ化
- コードレビューの効率化（契約による仕様の明確化）
- 保守性の向上（変更時の影響範囲の明確化）

**Alstom社の連動装置**
Alstom社は、鉄道信号システムの連動装置（ポイントと信号機の制御ロジック）の実装にSPARKを評価している。連動装置は、複数の列車が同時に駅構内で安全に運行できるように制御する極めて重要なシステムである。

**Siemens Mobility社の研究プロジェクト**
Siemens Mobility社は、自動運転列車（ATO: Automatic Train Operation）の制御アルゴリズムの検証にSPARKを試験的に使用している。特に、加速・減速の制御ロジックにおいて、物理的制約（最大加速度、ブレーキ性能）を契約として表現し、これらが常に満たされることをGNATproveで証明している。

## 防衛分野での応用

### セキュリティとSPARK

防衛分野では、安全性（Safety）だけでなくセキュリティ（Security）も重要な要件となる。SPARKの形式検証能力は、以下のセキュリティ関連の性質の検証にも有効である：

**情報フロー解析**
GNATproveのフロー解析機能は、機密情報が意図しない経路を通じて漏洩しないことを検証できる。例えば、高セキュリティレベルの変数が低セキュリティレベルの変数に影響を与えないこと（非干渉性、Non-interference）を検証可能である。

**暗号プリミティブの実装**
SPARKは、暗号アルゴリズムの実装において、サイドチャネル攻撃に対する耐性（定数時間実行、秘密に依存しない制御フロー）を保証するために使用される。例えば、条件分岐が秘密鍵に依存しないことを契約として表現し、検証できる。

### 実際の防衛プロジェクト

**MILS（Multiple Independent Levels of Security）アーキテクチャ**
米国国防総省のDARPA（Defense Advanced Research Projects Agency）が推進したMILSプロジェクトでは、異なるセキュリティレベルのアプリケーションを単一のプラットフォーム上で安全に実行するための基盤技術が研究された。この文脈で、SPARKは分離カーネル（Separation Kernel）の実装に使用されている。

**軍事通信システム**
BAE Systems社は、軍事通信システムの一部（メッセージルーティング、暗号化/復号化モジュール）にSPARKを採用している。特に、バッファオーバーランのような脆弱性を実行前に排除できることが高く評価されている。

**無人兵器システム**
無人航空機（UAV）や自律型地上車両の制御ソフトウェアにおいて、SPARKは安全性とセキュリティの両面から注目されている。敵対的な環境での動作を前提とすると、ソフトウェアのバグがもたらすリスクは極めて高い。

## ゼロ欠陥開発の実践

### 開発プロセスの統合

SPARKによるゼロ欠陥開発は、単にツールを使用するだけでなく、開発プロセス全体への統合が必要である。典型的なSPARK開発プロセスは以下のステップから構成される：

1. **要求分析と形式仕様**: システム要求を分析し、主要な安全性特性を特定する。これらをPre/Post条件、Type_Invariantとして形式化する。

2. **段階的実装と検証**: まずStone Level（フロー解析）を通過する実装を作成し、次にBronze Level（実行時エラー排除）を目指す。各段階でGNATproveのフィードバックに基づいて実装を改善する。

3. **契約の洗練**: 実装が進むにつれて、契約をより詳細に記述する。初期段階では粗い契約から始め、段階的に精緻化する。

4. **証明の支援**: 自動証明が失敗する箇所については、ループ不変条件、中間アサーション、補題（Ghost関数）を追加して証明を支援する。

5. **統合とテスト**: 形式検証されたSPARKコードと、検証されていない外部コンポーネント（デバイスドライバ、OS呼び出しなど）の統合点では、従来のテストを実施する。

### ケーススタディ: Tokeneer

Tokeneerは、NSA（米国国家安全保障局）が資金提供し、Praxis社が実装したセキュアドアシステムのデモンストレーションプロジェクトである。このプロジェクトは、SPARKの能力を実証するための最も包括的な公開ケーススタディの一つである。

**プロジェクト規模**:
- 約10,000行のSPARKコード
- 完全なSPARK検証（Stone〜Gold Level）
- Common Criteria EAL5レベルのセキュリティ評価を想定

**成果**:
- 実装フェーズでのバグ密度: 0.04バグ/KLOC（業界平均の1/100以下）
- GNATproveによる実行時エラーのゼロ化
- セキュリティプロパティの形式的証明

Tokeneerプロジェクトは、SPARKが大規模なシステムにも適用可能であり、極めて高い品質を達成できることを実証した。

### 開発コストと投資対効果

SPARK採用の初期コストは無視できない。開発者のトレーニング、契約の記述、証明の支援に追加の工数が必要となる。しかし、多くのプロジェクトで以下の効果が報告されている：

- **デバッグ時間の大幅削減**: 実行時エラーが事前に排除されるため、デバッグに費やす時間が劇的に減少する。
- **保守コストの削減**: 契約により仕様が明確化され、変更の影響範囲が理解しやすくなる。
- **認証コストの削減**: 形式検証のエビデンスが、DO-178CやEN 50128などの認証プロセスで活用できる。

Praxis社の報告によると、初回のSPARKプロジェクトでは従来手法と比較して約20%のコスト増加が見られるが、2回目以降のプロジェクトではむしろコスト削減が達成されるとのことである。

## 他の言語との比較

### SPARKとRust

近年、安全なシステムプログラミング言語としてRustが注目されている。RustとSPARKは、安全性の保証という点で目標を共有しているが、アプローチが大きく異なる：

**メモリ安全性**:
- Rust: 所有権システムと借用チェッカーにより、コンパイル時にメモリ安全性を保証（形式検証なし）
- SPARK: ポインタの制限とGNATproveによる形式検証により、メモリ安全性を保証

**並行性**:
- Rust: Send/Syncトレイトによりデータ競合を防止（コンパイル時チェック）
- SPARK: 現在のSPARKはタスキングを制限しており、並行性のサポートは限定的（Ravenscar profileによる制限付き並行性は可能）

**認証と産業採用**:
- Rust: 新しい言語であり、認証基準（DO-178C、EN 50128）での実績は限定的
- SPARK: 30年以上の歴史があり、多くの認証プロジェクトで実績がある

**形式検証のレベル**:
- Rust: 型システムによる安全性保証が中心（関数的正しさの証明は別ツールが必要）
- SPARK: 関数的正しさまで含む完全な形式検証が可能

実用面では、Rustはより広範なドメインで使用可能であり、エコシステムも豊かである。一方、SPARKは認証が必要な安全性/セキュリティクリティカルなシステムにおいて、より強力な保証を提供する。

### SPARKとその他の形式検証言語

**Frama-C（Cの形式検証）**:
Frama-Cは、C言語プログラムの形式検証ツールである。ACSL（ANSI/ISO C Specification Language）により契約を記述し、WP（Weakest Precondition）プラグインなどで検証する。SPARKと比較して、既存のCコードベースに適用しやすいが、Cの複雑さ（ポインタ、未定義動作）により検証の難易度は高い。

**seL4（形式検証されたマイクロカーネル）**:
seL4は、Isabelle/HOL証明支援系を用いて完全に検証されたマイクロカーネルである。実装（C）と仕様（Haskell）の間の精緻化証明を含む、極めて高いレベルの検証が達成されている。SPARKと比較して、検証のレベルは最高峰だが、検証コストも極めて高い（約20人年）。

**Dafny、F*などの検証指向言語**:
Dafny（Microsoft Research）やF*（Inria, Microsoft Research）は、プログラムと証明を統合した検証指向言語である。SPARKと同様に、契約ベースの検証とSMTソルバーの使用を特徴とする。産業適用の実績ではSPARKが優位だが、研究コミュニティではこれらの新しい言語が活発に研究されている。

## SPARKの利点と制約

### 主な利点

1. **数学的保証**: テストでは発見困難なエッジケースを含む、すべての実行パスに対する数学的保証が得られる。

2. **早期のバグ発見**: 実装段階で多くのバグが発見されるため、後工程でのコスト増大を回避できる。

3. **ドキュメンテーション**: 契約は、実行可能な仕様として機能し、コードの意図を明確に伝える。

4. **認証サポート**: DO-178C、EN 50128などの認証プロセスにおいて、形式検証のエビデンスが活用できる。

5. **長期的な保守性**: 契約により変更の影響範囲が明確化され、リファクタリングやバグ修正が容易になる。

### 主な制約

1. **言語機能の制限**: Adaの動的機能（ポインタ、例外、動的メモリ割り当て）が制限される。これにより、一部のアルゴリズムやデータ構造の実装が困難になる。

2. **学習曲線**: 形式手法の概念（Pre/Post条件、ループ不変条件）の習得には時間がかかる。

3. **証明の複雑さ**: 複雑なロジックでは、自動証明が失敗し、手動での証明支援が必要となる。これには専門知識が要求される。

4. **ツールチェインの成熟度**: GNATproveは活発に開発されているが、一部の言語機能やライブラリのサポートは不完全である。

5. **エコシステムの規模**: RustやC++と比較して、SPARKのライブラリやツールのエコシステムは小規模である。

### 適用領域の選択

SPARKは、以下の条件を満たすプロジェクトに特に適している：

- 安全性またはセキュリティが最優先の要件である
- 認証（DO-178C、EN 50128、Common Criteriaなど）が必要である
- ソフトウェアのバグがもたらすコスト（人命、財産、評判）が極めて高い
- システムの複雑さが中程度であり、形式仕様が現実的に記述可能である
- 長期的な運用と保守が予定されている

逆に、以下のような場合はSPARKの適用は困難または不適切である：

- 要求が頻繁に変化する開発初期フェーズ
- 高度に動的なシステム（GCを多用する、ポインタ操作が本質的なアルゴリズムなど）
- 短期間のプロトタイプ開発
- 開発チームに形式手法のトレーニングリソースが不足している

## 最新の動向と将来展望

### SPARK Pro（2020年〜）

AdaCoreは2020年に、SPARK Proとしてエンタープライズ向けの機能強化を発表した。主な追加機能は以下の通り：

- **Ghost Code**: 検証のためだけに存在し、実行時には削除されるコード。証明を支援する補題や中間状態の記述に使用される。
- **High-Level Property（HLP）**: より抽象的なレベルでのプロパティ記述をサポート。
- **改善されたSMTソルバー統合**: Z3、CVC4、Alt-Ergoの最新バージョンとの統合による証明能力の向上。

### 並行性とRavenscar Profile

現在のSPARKは並行性のサポートが限定的だが、Ravenscar Profileという制限付きタスキングモデルのサポートが進められている。Ravenscar Profileは、リアルタイムシステム向けに設計された決定論的な並行性モデルであり、以下の制約を含む：

- タスクの動的生成の禁止
- 単純な優先度ベーススケジューリング
- 制限されたタスク間通信

これにより、リアルタイム組み込みシステムでのSPARKの適用範囲が拡大している。

### 量子コンピューティング時代の暗号

量子コンピューティングの進展により、現在の公開鍵暗号（RSA、ECCなど）が脆弱になることが懸念されている。耐量子暗号（Post-Quantum Cryptography）の実装において、SPARKの形式検証能力は重要な役割を果たすと期待されている。暗号アルゴリズムの実装は極めて複雑であり、微細なバグが致命的な脆弱性につながる可能性があるためである。

### 自動運転車への応用

自動運転車のソフトウェアは、安全性とセキュリティの両面で最高水準の保証が求められる。現在、自動車産業ではISO 26262（機能安全）とISO/SAE 21434（サイバーセキュリティ）が適用されている。SPARKは、これらの規格が要求する形式手法の適用において有力な選択肢となりつつある。

特に、センサーフュージョン、経路計画、車両制御といった安全クリティカルなコンポーネントでのSPARK適用が研究されている。ただし、機械学習ベースの認識システムとの統合が課題となっている（現在のSPARKは機械学習モデルの検証をサポートしていない）。

## まとめ

SPARK/Adaは、30年以上の実績を持つ形式検証可能なプログラミング言語であり、航空宇宙、鉄道、防衛といった安全性/セキュリティクリティカルなシステムの開発において重要な役割を果たしている。契約ベースの仕様記述とGNATproveによる自動検証の組み合わせにより、実行時エラーの完全な排除から関数的正しさの証明まで、幅広いレベルの保証が可能である。

SPARKの採用は、初期の学習コストと言語機能の制限という課題を伴うが、長期的にはデバッグ時間の削減、保守性の向上、認証コストの削減といった大きなメリットをもたらす。ゼロ欠陥開発という理想に最も近づいた実用的な技術として、SPARKは今後も安全性が極めて重要なシステムの開発において、不可欠な選択肢であり続けるだろう。

形式手法の分野では、Rust、Dafny、F*といった新しい言語やツールも登場しているが、認証が必要な産業応用においてはSPARKの実績と成熟度が強みとなっている。今後、並行性サポートの強化、機械学習との統合、ツールチェインの改善により、SPARKの適用範囲はさらに拡大していくことが期待される。

## 参考文献

1. McCormick, J. W., & Chapin, P. C. (2015). *Building High Integrity Applications with SPARK*. Cambridge University Press.
2. Barnes, J. (2012). *SPARK: The Proven Approach to High Integrity Software*. Altran Praxis.
3. Chapman, R., & Schanda, F. (2014). "Are We There Yet? 20 Years of Industrial Theorem Proving with SPARK". *International Conference on Interactive Theorem Proving*, 289-304.
4. Amey, P. (2012). "Correctness by Construction: Better Can Also Be Cheaper". *CrossTalk: The Journal of Defense Software Engineering*, 25(2), 24-28.
5. AdaCore. (2024). *SPARK User's Guide*. https://docs.adacore.com/spark2014-docs/html/ug/
6. RTCA. (2011). *DO-178C: Software Considerations in Airborne Systems and Equipment Certification*.
7. CENELEC. (2011). *EN 50128: Railway applications - Communication, signalling and processing systems - Software for railway control and protection systems*.
8. Klein, G., et al. (2014). "Comprehensive Formal Verification of an OS Microkernel". *ACM Transactions on Computer Systems*, 32(1), 1-70.
9. Tokeneer Project Documentation. (2008). Altran Praxis. Available at: https://www.adacore.com/tokeneer
10. Taft, S. T., Duff, R. A., Brukardt, R. L., Plödereder, E., & Leroy, P. (Eds.). (2012). *Ada 2012 Reference Manual*. Springer.
