# 多層宇宙と仕様の合成

## 概要

本調査では、仕様の多層構造における宇宙間の接続と合成について、形式手法とソフトウェアアーキテクチャの観点から調査した。特に以下の問題に焦点を当てた：

- システム全体の宇宙Uと個別コンポーネントの宇宙の関係
- 宇宙間の接続部（関数f、インターフェース、プロトコル）の定義
- 並列する宇宙の結合（UIとAPIなど、関心分離された領域）
- 階層的な上位-下位関係 vs 並列関係
- 接続部がU-D-Aモデルのどこに位置するか

## 1. 仕様の合成理論

### 1.1 リファインメント合成ロジック（Refinement Composition Logic）

ICFP 2024で発表された[Refinement Composition Logic](https://icfp24.sigplan.org/details/icfp-2024-papers/22/Refinement-Composition-Logic)は、プログラム検証における重要なアプローチを提示している：

- **基本原理**: プログラムが数学的仕様に従って振る舞うことを確立する
- **合成の重要性**: 最終結果は複数の「小さな」リファインメントを合成することで確立される
- **分離論理との対応**: リファインメントの合成タスクと、現代の分離論理における entailment の証明タスクの間に新しい対応関係が存在する
- **RCL**: リファインメントの合成に特化した論理として設計されている

**U-D-Aへの示唆**: リファインメントの合成は、抽象的な宇宙から具体的な宇宙への変換の連鎖として捉えられる。各リファインメントステップは、より制約された（Dが大きくなった）宇宙への移行を表す。

### 1.2 リファインメントと分解

[形式手法の研究](https://arxiv.org/html/2512.17334)では、仕様の分解とリファインメントについて以下が示されている：

- **階層的意味分解**: 自然言語要件を構造化されたOnionLツリーに階層的に分解
- **要件から形式仕様へ**: OnionL構造を検証・変換し、正しく標準化されたLTL式に変換
- **分解の目的**: 複雑な仕様を扱いやすい部分に分割し、それぞれを個別に検証可能にする

## 2. Assume-Guarantee推論と合成的検証

### 2.1 基本概念

[Assume-Guarantee推論](https://roars.dev/pubs/duong2025compositional.pdf)は、複雑な検証問題を分解するための強力な手法である：

- **仮定-保証の原理**: コンポーネントは、インターフェースで想定される入力を受け取る場合に、適切に振る舞うことを保証する
- **合成的検証**: サブシステムの仮定と保証を検証することで、全体システムの性質を証明
- **推移性**: 不変性の推移性に基づき、有限状態システムのassume-guarantee検証理論に似ている

### 2.2 最近の応用

**ニューラルネットワークの検証（CoVeNN）**:
- ニューラルネットワークをサブネットワークに分解
- 各サブネットワークを仮定と保証付きで検証
- すべてのサブネットワークの検証が、元のネットワークが望ましい性質を満たすことを保証
- 4つのヒューリスティックを用いた自動的なネットワーク分解

**線形計画法による契約の検証**:
- 個別コンポーネントの契約の集合が、合成されたシステムの契約をリファインする条件
- [線形プログラムを解くことで検証可能な必要十分条件](https://arxiv.org/abs/2103.13743)

**U-D-Aへの示唆**: Assume-Guarantee推論は、宇宙間の接続部を「仮定（A内の制約）」と「保証（別のコンポーネントに対するD内の制約）」として形式化する方法を提供する。接続部は、各宇宙のA（許容集合）の一部として表現できる。

## 3. 契約ベース設計（Design by Contract）

### 3.1 基本原理

[Bertrand Meyerによる契約ベース設計](https://en.wikipedia.org/wiki/Design_by_contract)は、ソフトウェア要素間の相互作用を統制する：

- **事前条件（Precondition）**: クライアントの義務、サプライヤーの利益
- **事後条件（Postcondition）**: クライアントの利益、サプライヤーの義務
- **不変条件（Invariant）**: 一般的なルール
- **ビジネスメタファー**: クライアントとサプライヤーが「契約」に基づいて合意

### 3.2 仕様と合成

- **仕様の関連付け**: すべてのソフトウェア要素に仕様を関連付ける
- **相互作用の統制**: これらの仕様（契約）が、要素と外界との相互作用を統制
- **合成の正しさ**: 正しいプログラムの合成は、クライアントプログラムがサプライヤークラスを正しく利用する方法を形式的に述べることで達成される

**U-D-Aへの示唆**:
- 事前条件は、入力側の宇宙のA（許容集合）の制約
- 事後条件は、出力側の宇宙でのD（望ましい振る舞い）の保証
- 不変条件は、宇宙内で常に成立すべきU内の制約
- 契約は、異なる宇宙間の接続部を定義する明示的な仕様

## 4. アーキテクチャ記述言語（ADL）とコネクタ

### 4.1 ADLの概要

[アーキテクチャ記述言語](https://en.wikipedia.org/wiki/Architecture_description_language)は、ソフトウェアアーキテクチャの記述に用いられる言語である：

- **コンポーネント・コネクタ抽象化**: コンポーネントは計算とデータストアの単位、コネクタはコンポーネント間の相互作用を記述
- **相互作用のルール**: コネクタは、相互作用とそれを統制するルールを記述する
- **主要なADL**: Acme（CMU）、AADL（SAE標準）、C2（UCI）、Darwin（Imperial College）、Wright（CMU）

### 4.2 Wrightのコネクタ形式化

[Wright](https://www.cs.cmu.edu/~able/wright/)は、コネクタの形式化に重要な貢献をしている：

- **コンポーネント、コネクタ、構成**: 基本的な抽象化の上に構築
- **インターフェース不整合とデッドロックの特定**: Wrightを使用して検出可能
- **構成の分割**: インスタンス、接続（システムのトポロジー記述）、階層（コンポーネントが他のコンポーネントを含む）

### 4.3 コネクタの形式化と合成

[コネクタの研究](https://www.semanticscholar.org/paper/A-compositional-formalization-of-connector-wrappers-Spitznagel-Garlan/95a16f95099fab4e0ab901ed9c2259baff08ec78/figure/0)では：

- **明示的意味エンティティ**: コネクタは、相互作用における各参加役割を特徴づけるプロトコルの集合
- **プロトコルマッチングと変換の自動推論**: 形式化により、プロトコルのマッチングと変換について自動推論が可能
- **動的合成**: 永続的なネットワークシステムを実現するための媒介コネクタの動的合成
- **階層的定義**: コネクタをサブコネクタから定義・構築可能（ジェネリック、合成的、再利用可能）
- **表現力のある計算**: コネクタ自体が合成可能で、同期、相互排他、非決定的選択、状態依存振る舞いの複雑な組み合わせを包含する意味論

**U-D-Aへの示唆**:
- コネクタは、異なる宇宙間の明示的な接続部を表現する第一級のエンティティ
- コネクタのプロトコルは、一方の宇宙のAから他方の宇宙のAへの変換ルール（関数f）として機能
- コネクタ自体が合成可能であることは、接続部も階層的に構造化できることを示唆

## 5. コンポーネントベース仕様とインターフェース理論

### 5.1 インターフェース仕様

[コンポーネントベース仕様](https://dl.acm.org/doi/10.1145/3508352.3549341)における重要な概念：

- **個別チェック可能性**: インターフェース仕様は各コンポーネントについて個別にチェック可能
- **合成後の性質保証**: 各コンポーネントでチェックされたリファインメントベースの性質は、合成後も保持される
- **追加検証の必要性**: すでに検証された設計コンポーネントを合成する際、インターフェースでの不正な通信が個別に検証された性質を無効にする可能性があるため、追加検証が必要

### 5.2 インターフェースオートマトン（de Alfaro & Henzinger）

[Interface Automata](https://www.semanticscholar.org/paper/Interface-automata-Alfaro-Henzinger/39cc378c7ea602329ddd586b8254dd856d740771)は、コンポーネントインターフェースの重要な形式化を提供する：

- **時間的側面の捕捉**: ソフトウェアコンポーネントインターフェースの時間的側面を捕捉
- **入力仮定と出力保証**: コンポーネントのメソッドが呼ばれる順序についての入力仮定と、コンポーネントが外部メソッドを呼ぶ順序についての出力保証の両方を捕捉
- **楽観的合成**: 何らかの環境が2つのコンポーネントを協調させられる場合、それらは互換性がある
- **交互リファインメント**: あるインターフェースが別のインターフェースをリファインするのは、より弱い入力仮定とより強い出力保証を持つ場合
- **入出力の区別**: 入力アクションと出力アクションを区別し、並列合成を定義（コンポーネントは入力で待機可能だが出力では決して待機しない）
- **通信エラー**: あるコンポーネントが準備できていないメッセージを受信する場合、通信エラーが発生

**インターフェース理論の影響**:
- 並行システム、時間付きシステム、リソース、Webサービス、プログラムAPIのためのインターフェース理論が開発されている
- 環境と実装の関心分離
- 型チェックより包括的な互換性チェックを可能にする軽量な振る舞いインターフェース
- 仕様の楽観的合成の概念

**U-D-Aへの示唆**:
- インターフェースオートマトンは、宇宙間の接続部を形式的に記述する強力なモデル
- 各宇宙のA（許容集合）は、インターフェースの入力仮定として表現される
- 各宇宙のD（望ましい振る舞い）は、出力保証として表現される
- 楽観的合成は、複数の宇宙が相互作用可能な条件を定義する

## 6. 階層的合成：垂直と水平

### 6.1 トップダウン vs ボトムアップ

[階層的仕様分解](https://en.wikipedia.org/wiki/Bottom-up_and_top-down_approaches)には2つの主要なアプローチがある：

**トップダウンアプローチ**:
- システムの概要を定式化し、第一レベルのサブシステムを指定
- 各サブシステムをより詳細にリファインし、全体の仕様を基本要素まで還元
- 段階的リファインメント（Stepwise Refinement）として知られる
- 全体像を早期に理解できるが、低レベルの制約を見落とす可能性

**ボトムアップアプローチ**:
- システムの個々の基本要素を最初に詳細に指定
- これらの要素を結合してより大きなサブシステムを形成
- 実用的な実現可能性を最初から保証するが、統合の課題につながる可能性

**リファインメント層**:
- システム全体を階層的にサブシステムに分割
- トップレベルでは振る舞い記述を使用
- 構造記述とコンポーネントの振る舞い記述に分割
- 各設計イテレーションのサブシステムは、より多くの詳細を用いて記述される

### 6.2 垂直合成と水平合成

[垂直と水平の合成](https://www.researchgate.net/publication/221549495_Combining_Horizontal_and_Vertical_Composition_of_Services)は、異なる次元での仕様の統合を表す：

**垂直合成**:
- 層状アーキテクチャのすべての層で発生するサービス合成
- コンポーネントのデプロイメント
- 単一の実行可能アプリケーション内のアプリケーション層に関する
- システムが層またはティアに構造化され、各層が特定レベルの機能に責任を持つ

**水平合成**:
- 同じ層で発生するサービス合成
- コンポーネントやライブラリの構築と使用に関する
- アプリケーションを異なるサービスに分離する（例：マイクロサービス）

**層状アーキテクチャの仕様**:
- インターフェース振る舞いとモジュール合成の正確な仕様に基づくアーキテクチャパターン
- インターフェース述語とインターフェースアサーションを使用して、システムのインターフェース振る舞いを仕様化
- システムが必要とし提供するサービスの記述

**U-D-Aへの示唆**:
- 垂直合成は、階層的な上位-下位の宇宙関係を表現（リファインメント）
- 水平合成は、並列する宇宙の結合を表現（例：UIコンポーネントとAPIの関心分離）
- 各層は独自のU-D-Aトリプルを持ち、層間の接続部はインターフェースとして形式化される

## 7. 圏論的視点

### 7.1 基本概念

[圏論](https://syndu.com/blog/composition-of-morphisms-building-connections-in-category-theory/)は、仕様の合成に対する統一的な数学的枠組みを提供する：

- **対象と射**: 圏は対象（宇宙）と射（射の元と対象を関係づける）で形成される
- **射の合成**: f: A → B と g: B → C がある場合、その合成 g ∘ f は A から C への射
- **結合律と恒等射**: 射の合成は結合律を満たし、各対象に恒等射が存在
- **APIアナロジー**: プログラムのAPIやJavaのインターフェースと類似（内部は見えないが、入力と出力の種類がわかる）

### 7.2 応用圏論

2010年代と2020年代に応用圏論が大きく成長：

- **圏論的データベース**: David Spivakによる、スキーマを有限圏として、データ移行を関手として扱う研究
- **機械学習との統合**: ニューラルアーキテクチャとベイズ推論における関手的意味論などの合成モデル
- **合成的モデル**: 複雑なシステムを小さな部分から合成する統一的な方法

**U-D-Aへの示唆**:
- 各宇宙（U-D-Aトリプル）は圏の対象として捉えられる
- 宇宙間の接続部（関数f、インターフェース、プロトコル）は射として形式化される
- 複数の宇宙を経由する変換の連鎖は、射の合成として表現される
- 圏論の枠組みは、仕様の合成の数学的正しさを保証する基盤を提供

## 8. U-D-Aモデルにおける多層宇宙

### 8.1 宇宙の種類

調査結果に基づき、U-D-Aモデルにおける多層宇宙は以下のように分類できる：

#### 階層的関係（垂直合成）
- **抽象宇宙 → 具体宇宙**: トップダウンのリファインメント
  - U₁-D₁-A₁（高レベル仕様） → U₂-D₂-A₂（低レベル実装）
  - D₁ ⊆ D₂（より多くの詳細が定義される）
  - A₁ ⊇ A₂（より多くの制約が追加される）

- **具体宇宙 → 抽象宇宙**: ボトムアップの抽象化
  - 詳細な実装から高レベル仕様への抽象化
  - 実装の詳細を隠蔽し、本質的な振る舞いを抽出

#### 並列関係（水平合成）
- **関心分離された宇宙**: 同じ抽象レベルで異なる側面を扱う
  - UIコンポーネントの宇宙（U_UI, D_UI, A_UI）
  - APIの宇宙（U_API, D_API, A_API）
  - データベースの宇宙（U_DB, D_DB, A_DB）

### 8.2 接続部の形式化

宇宙間の接続部は、以下の複数の観点から形式化できる：

#### 1. 関数としての接続部（数学的視点）
```
f: A₁ → A₂
```
- 一方の宇宙の許容状態を、他方の宇宙の許容状態に変換する関数
- 圏論における射（morphism）として形式化

#### 2. インターフェースとしての接続部（ソフトウェア工学的視点）
```
Interface I {
  preconditions: A₁の制約
  postconditions: A₂の制約
  invariants: 両宇宙で保たれるべき性質
}
```
- Design by Contractにおける契約として形式化
- インターフェースオートマトンとして振る舞いを記述

#### 3. プロトコルとしての接続部（アーキテクチャ的視点）
```
Connector C {
  roles: [role₁, role₂, ...]
  protocols: {role → behavior}
  glue: 相互作用の調整ルール
}
```
- ADLにおけるコネクタとして形式化
- 複雑な調整とコーディネーションを表現

#### 4. 仮定-保証としての接続部（検証的視点）
```
Component₁:
  assumes: A₁（環境についての仮定）
  guarantees: D₁（提供する保証）

Component₂:
  assumes: A₂（D₁を含む）
  guarantees: D₂
```
- Assume-Guarantee推論として形式化
- 合成的検証を可能にする

### 8.3 接続部はU-D-Aのどこに位置するか

重要な洞察: **接続部は主にA（許容集合）の一部として表現される**

#### 接続部のA内での表現
- **送信側のA**: 出力インターフェースの制約として
  - 「出力は特定の形式に従わなければならない」
  - 「事後条件: 出力が相手の事前条件を満たす」

- **受信側のA**: 入力インターフェースの制約として
  - 「入力は特定の形式に従うと仮定する」
  - 「事前条件: 入力が特定の性質を持つ」

#### 接続部のU外での表現
- **グローバルな接続部**: 複数の宇宙を統合するメタレベルの構造
  - 全体システムのU内に、個別宇宙間の関係を記述する要素が存在
  - アーキテクチャ記述として、別の抽象レベルで表現される

#### ハイブリッドな見方
接続部は、以下の両方として理解できる：
1. **各宇宙のA内**: ローカルな視点（各コンポーネントの契約）
2. **メタ宇宙内**: グローバルな視点（全体アーキテクチャの記述）

### 8.4 多層宇宙の合成規則

調査結果から、以下の合成規則が導出される：

#### 垂直合成（リファインメント）
```
(U₁, D₁, A₁) ⊑ (U₂, D₂, A₂)
iff
  U₁ = U₂ ∧
  D₁ ⊆ D₂ ∧
  A₁ ⊇ A₂ ∧
  ∀s ∈ U₁: s ∈ A₁ ⇒ s ∈ A₂
```

#### 水平合成（並列結合）
```
(U₁, D₁, A₁) ⊗ (U₂, D₂, A₂) = (U₃, D₃, A₃)
where
  U₃ = U₁ × U₂ (直積)
  D₃ = D₁ × D₂
  A₃ = {(s₁, s₂) | s₁ ∈ A₁ ∧ s₂ ∈ A₂ ∧ compatible(s₁, s₂)}

  compatible(s₁, s₂) = connector.check(s₁, s₂)
```

#### インターフェースによる制約
```
Interface I: A₁ → A₂
Component₁ with (U₁, D₁, A₁) と Component₂ with (U₂, D₂, A₂) を接続する場合:
  A₁' = A₁ ∩ I.preconditions
  A₂' = A₂ ∩ {s | I(A₁') → s}
```

## 9. 実践的示唆と未解決問題

### 9.1 実践的示唆

1. **仕様の階層化**
   - システムを複数の抽象レベルで記述
   - 各レベルで独立したU-D-Aトリプルを定義
   - リファインメント関係を明示的に記述

2. **インターフェースの明示化**
   - コンポーネント間の接続部を第一級の仕様要素として扱う
   - 契約（事前条件、事後条件、不変条件）を明示的に記述
   - インターフェースオートマトンなどの形式的モデルを使用

3. **合成的検証**
   - Assume-Guarantee推論を用いて、部分システムの検証結果から全体システムの性質を導出
   - 各宇宙を独立に検証し、接続部の整合性を確認

4. **アーキテクチャ記述言語の活用**
   - コネクタを明示的に記述し、複雑な調整ロジックを形式化
   - ADLを用いてシステム全体の構造を記述

### 9.2 未解決問題

1. **動的な宇宙の変化**
   - 実行時に宇宙の構造が変化する場合（適応システム、進化システム）
   - 接続部が動的に生成・削除される場合

2. **循環的依存**
   - 宇宙A→B→C→Aのような循環的な接続
   - 相互再帰的な仕様の扱い

3. **非決定性と確率**
   - 確率的な振る舞いを持つ宇宙の合成
   - 非決定性が接続部を通じて伝播する場合

4. **スケーラビリティ**
   - 多数の宇宙が相互接続されたシステムの仕様
   - 大規模システムにおける合成的検証の計算コスト

5. **接続部の検証**
   - 接続部自体が正しく実装されているかの検証
   - プロトコルの整合性チェックの自動化

## 10. まとめ

多層宇宙と仕様の合成に関する調査から、以下の主要な知見が得られた：

### 主要な理論的基盤
1. **リファインメント合成**: 抽象から具体への段階的な変換
2. **Assume-Guarantee推論**: 合成的検証のための強力な手法
3. **契約ベース設計**: 事前条件・事後条件・不変条件による明示的な契約
4. **アーキテクチャ記述言語**: コネクタを第一級エンティティとして扱う
5. **インターフェース理論**: 楽観的合成と交互リファインメント
6. **圏論**: 仕様合成の統一的な数学的枠組み

### U-D-Aモデルへの統合
- **階層的宇宙**: 垂直合成（リファインメント）により、抽象から具体へ
- **並列宇宙**: 水平合成により、関心分離された領域を統合
- **接続部の形式化**: 主にA（許容集合）の一部として、時にメタ宇宙として
- **合成規則**: 垂直・水平の両方向での明示的な合成演算

### 今後の方向性
- 動的・適応的システムへの拡張
- 確率的・非決定的振る舞いの扱い
- 大規模システムへのスケーラビリティ
- 接続部の自動検証と合成

多層宇宙のモデルは、複雑なソフトウェアシステムの仕様を階層的・合成的に記述するための強力な枠組みを提供する。既存の形式手法やアーキテクチャ理論と統合することで、実用的かつ検証可能な仕様記述手法の実現が期待される。

## 参考文献

### 仕様の合成とリファインメント
- [Refinement Composition Logic (ICFP 2024)](https://icfp24.sigplan.org/details/icfp-2024-papers/22/Refinement-Composition-Logic)
- [Bridging Natural Language and Formal Specification – Automated Translation](https://arxiv.org/html/2512.17334)

### Assume-Guarantee推論
- [Compositional Neural Network Verification via Assume-Guarantee Reasoning](https://roars.dev/pubs/duong2025compositional.pdf)
- [Compositional Inductive Invariant Inference via Assume-Guarantee Reasoning](https://arxiv.org/pdf/2509.06250)
- [Verifying Compositional Refinement of Assume/Guarantee Contracts using Linear Programming](https://arxiv.org/abs/2103.13743)

### 契約ベース設計
- [Design by contract - Wikipedia](https://en.wikipedia.org/wiki/Design_by_contract)
- [Design by Contract Introduction - Eiffel Software](https://www.eiffel.com/values/design-by-contract/introduction/)
- [Chapter 1 Design by Contract Bertrand Meyer](https://se.inf.ethz.ch/~meyer/publications/old/dbc_chapter.pdf)

### アーキテクチャ記述言語とコネクタ
- [Architecture description language - Wikipedia](https://en.wikipedia.org/wiki/Architecture_description_language)
- [The Wright Architecture Description Language](https://www.cs.cmu.edu/~able/wright/)
- [A compositional formalization of connector wrappers](https://www.semanticscholar.org/paper/A-compositional-formalization-of-connector-wrappers-Spitznagel-Garlan/95a16f95099fab4e0ab901ed9c2259baff08ec78/figure/0)

### コンポーネントベース仕様とインターフェース理論
- [Compositional Verification Using a Formal Component and Interface Specification](https://dl.acm.org/doi/10.1145/3508352.3549341)
- [An Interface Theory for Program Verification](https://link.springer.com/chapter/10.1007/978-3-030-61362-4_9)
- [Interface automata](https://www.semanticscholar.org/paper/Interface-automata-Alfaro-Henzinger/39cc378c7ea602329ddd586b8254dd856d740771)
- [Modal Interface Automata](https://arxiv.org/abs/1306.3050)

### 階層的合成
- [Bottom-up and top-down approaches - Wikipedia](https://en.wikipedia.org/wiki/Bottom-up_and_top-down_approaches)
- [Combining Horizontal and Vertical Composition of Services](https://www.researchgate.net/publication/221549495_Combining_Horizontal_and_Vertical_Composition_of_Services)

### 圏論的アプローチ
- [A Brief Introduction to Category Theory for Systems](https://www.omg.org/maths/September-2024-Mathsig-Presentation-to-the-AI-PTF.pdf)
- [Composition of Morphisms: Building Connections in Category Theory](https://syndu.com/blog/composition-of-morphisms-building-connections-in-category-theory/)
- [Category Theory for Computing Science](https://www.math.mcgill.ca/triples/Barr-Wells-ctcs.pdf)
