# 形式手法・形式仕様記述

## 1. 形式手法の定義と概要

形式手法（Formal Methods）とは、数学的に厳密な基盤に基づいてソフトウェアおよびハードウェアシステムの仕様記述・開発・検証を行う技術の総称である。数理論理学、集合論、オートマタ理論、プログラム意味論、型システムなどを活用し、システムの振る舞いや性質を曖昧さなく定義する。

形式手法の最大の利点は、要求や設計における矛盾・曖昧さ・抜け漏れなどの誤りを、開発の早期段階で数学的に検出できる点にある。一方、そのコストが利益に見合う場面は限られており、航空宇宙・鉄道・原子力などのセーフティクリティカルな領域で特に活用されてきた。

## 2. 形式手法の分類

形式手法は大きく以下の3つのアプローチに分類される。

### 2.1 形式仕様記述（Formal Specification）

数学的な言語を用いてシステムの仕様を厳密に記述する手法。画面・振る舞い・データモデルを含むシステム全体を対象とし、証明ツールによって仕様の整合性を検証する。状態空間の記述と不変条件の定義が中核をなす。

### 2.2 形式検証（Formal Verification）/ 定理証明

定理証明器（Theorem Prover）を用いて、システムの性質に関する数学的証明を構成する手法。公理系と推論規則に基づき、仕様が所望の性質を満たすことを演繹的に証明する。証明支援系（Proof Assistant）を通じた対話的証明が一般的である。

### 2.3 モデル検査（Model Checking）

システムが取りうるすべての状態を網羅的に探索し、安全性（Safety）や活性（Liveness）といった時相論理で記述された性質に違反がないかを自動的に検査する手法。性質違反が見つかった場合は反例（Counterexample）を出力する。「プッシュボタン」型の自動化が大きな特徴である。

## 3. 主要な形式仕様記述言語

### 3.1 Z記法（Z Notation）

- **基盤**: 公理的集合論、ラムダ計算、一階述語論理
- **特徴**: スキーマ（Schema）と呼ばれる独自の構造化機構を持ち、宣言と制約のパターンをまとめてシステムの状態と状態遷移を記述する。スキーマ計算により、小さなスキーマを論理演算子で組み合わせて大きな仕様を構築できる
- **数学ツールキット**: 集合・タプル・関係・関数・列に関する標準的な数学的定義と法則のカタログを内蔵
- **標準化**: 2002年にISO標準（ISO/IEC 13568:2002）として完成
- **課題**: 独自の数学的語彙が多く、習得に時間を要する

### 3.2 B Method / Event-B

- **基盤**: 集合論、一階述語論理、代入計算
- **特徴**: 抽象機械（Abstract Machine）の概念に基づき、段階的詳細化（Refinement）を通じて抽象仕様から実装コードまでを体系的に導出する。Event-Bはイベント駆動型の拡張であり、より厳密な構造を持つ
- **ツール**: Atelier B（B Methodの統合環境）、Rodin Platform（Event-Bの開発環境）
- **強み**: 証明義務（Proof Obligation）の体系的生成とコード生成への直結性
- **代表的適用**: パリメトロ14号線の自動運転システム

### 3.3 VDM（Vienna Development Method）

- **基盤**: 表示的意味論に由来するメタ言語Meta-IV
- **VDM-SL**: 型構成子（集合・列・写像）を用いたデータ定義と、事前条件・事後条件による暗黙的操作定義を特徴とする平坦な仕様記述言語。モジュール拡張を持つ
- **VDM++**: VDM-SLをオブジェクト指向に拡張し、クラス・多重継承・アクセス修飾子・並行性のモデリングを可能にした言語
- **特徴**: 形式的意味論を持ちつつ実行可能なサブセットを備え、GUIを通じた仕様のテスト実行が可能。形式手法に不慣れなドメイン専門家による評価を容易にする
- **ツール**: Overture Tool、VDMTools

### 3.4 TLA+

- **開発者**: Leslie Lamport
- **基盤**: 時相論理（Temporal Logic）とアクションの論理の融合。ZF集合論に基づく
- **特徴**: 非プライム変数（現在の状態）とプライム変数（次の状態）によるアクションの定義、時相演算子による安全性・活性の記述。分散システム・並行システムの仕様記述に特化
- **ツール**: TLC（有限モデル検査器）、TLAPS（証明システム）、PlusCal（アルゴリズム記述言語）
- **強み**: 分散システムの設計検証における実用性の高さ
- **代表的適用**: Amazon Web Servicesにおける大規模分散システムの設計検証

### 3.5 Alloy

- **開発者**: Daniel Jackson（MIT）
- **基盤**: 一階関係論理（First-Order Relational Logic）
- **特徴**: 宣言的な仕様記述とSATソルバーを利用した有界モデル検査（Bounded Model Checking）を組み合わせた軽量形式手法の代表格。仕様を関係論理で記述し、有限スコープ内でのモデル探索により反例を自動検出する
- **設計思想**: 「マイクロモデル」を素早く作成し自動検査することで、ソフトウェア設計の本質的な構造を探求する
- **ツール**: Alloy Analyzer
- **バージョン**: Alloy 6では時相論理のサポートが追加され、動的振る舞いの記述が強化された

## 4. 証明支援系（Proof Assistants）

### 4.1 Coq（現Rocq）

- **基盤**: 帰納的構成の計算（Calculus of Inductive Constructions）、依存型理論
- **特徴**: タクティクベースの対話的証明開発、証明からの実行可能プログラム抽出（Program Extraction）、大規模開発のためのモジュールシステムを先駆的に導入。de Bruijn基準を満たし、証明の信頼性が高い
- **代表的成果**: CompCert（形式検証済みCコンパイラ）、四色定理の形式証明

### 4.2 Isabelle/HOL

- **基盤**: 高階論理（Higher-Order Logic）
- **特徴**: Standard MLとScalaで実装。LCF方式に基づく小さな論理カーネルにより証明の信頼性を担保。柔軟なフレームワーク上で論理的に安全な拡張が可能
- **自動化**: Sledgehammerなどの強力な自動証明ツールを統合
- **代表的成果**: seL4マイクロカーネルの完全な機能正当性の形式検証

### 4.3 Lean

- **開発者**: Leonardo de Moura（Microsoft Research、2013年〜）
- **基盤**: 依存型理論
- **特徴**: Lean 4（2021年）はゼロからの完全再設計で、Cへのコンパイルにより高速に動作。対話的定理証明と自動推論の両方に適した設計。Mathlibという大規模数学ライブラリを擁し、数学の形式化において急速に普及
- **近年の動向**: AI支援証明との統合、数学コミュニティでの採用拡大

### 4.4 ACL2

- **基盤**: 一階論理、Lispベースの非型付き計算基盤
- **特徴**: Boyer-Moore系の定理証明器の集大成。強力な自動化ヒューリスティクスにより証明発見を支援。依存型を持たず、高階関数も直接扱えないが、実用的な自動化の度合いが高い
- **注意点**: de Bruijn基準を満たさず、内部の決定手続きが証明の痕跡を残さない

### 証明支援系の比較

| 特性 | Coq/Rocq | Isabelle/HOL | Lean 4 | ACL2 |
|------|----------|-------------|--------|------|
| 型体系 | 依存型 | 高階論理 | 依存型 | 一階・非型付き |
| 自動化の度合い | 中程度 | 高い | 中〜高 | 非常に高い |
| de Bruijn基準 | 満たす | 満たす | 満たす | 満たさない |
| プログラム抽出 | 可能 | 部分的 | ネイティブ | 直接実行 |
| 学習曲線 | 急峻 | 中程度 | 比較的緩やか | 中程度 |

## 5. モデル検査ツール

### 5.1 SPIN

- **開発者**: Gerard J. Holzmann（Bell Labs、1980年〜）
- **入力言語**: Promela（Process Meta Language）
- **検証性質**: 線形時相論理（LTL）で記述された性質、デッドロック不在、不到達コード
- **特徴**: Promelaモデルからの効率的なC言語検証器の自動生成。プロセス間通信（同期的ランデブー／非同期バッファ）のモデリング。分散・並行システムの検証に強い

### 5.2 NuSMV

- **基盤**: SMV（Symbolic Model Verifier）の再実装
- **検証性質**: CTL（計算木論理）およびLTL
- **特徴**: 記号的モデル検査によりBDD（二分決定図）を活用した状態空間の効率的な表現。ハードウェア検証を起源とし、有限状態システムの検証に適する

### 5.3 UPPAAL

- **特化領域**: リアルタイムシステムの検証
- **基盤**: 時間オートマタ（Timed Automata）
- **特徴**: 時間制約を伴うシステムのモデリングと検証に特化。時間付きモデルにおいて最高の性能を発揮。シミュレーション・検証・テスト生成の統合環境を提供

### モデル検査ツールの比較

| 特性 | SPIN | NuSMV | UPPAAL |
|------|------|-------|--------|
| 入力言語 | Promela | SMV言語 | 時間オートマタ |
| 検証論理 | LTL | CTL, LTL | TCTL |
| 得意分野 | 並行・分散システム | 有限状態システム | リアルタイムシステム |
| 状態空間探索 | 明示的 | 記号的（BDD） | ゾーンベース |

## 6. 産業界での成功事例

### 6.1 パリメトロ14号線（B Method）

ClearSY社がB Methodを用いて自動運転制御ソフトウェアを開発。25年以上にわたり無事故で運行を継続しており、形式手法の産業適用における最も長期的かつ成功した事例の一つである。段階的詳細化により抽象仕様から実行コードまでを一貫して検証した。

### 6.2 Amazon Web Services（TLA+）

2011年以降、AWSのエンジニアはTLA+を10以上の大規模複雑システムの設計検証に使用。すべてのケースで「他の手段では発見できなかった微妙なバグの発見」または「正当性を犠牲にしない積極的な性能最適化への確信」という顕著な価値をもたらした。AWSのリーダーシップは「自動推論のゴールデンエイジ」を標榜している。

### 6.3 seL4マイクロカーネル（Isabelle/HOL）

汎用商用マイクロカーネルseL4のフル機能正当性をIsabelle/HOLで形式証明。産業品質の高性能OSとして初めて完全な機械的証明を達成し、2022年ACMソフトウェアシステム賞を受賞した。

### 6.4 CompCertコンパイラ（Coq）

複数の商用アーキテクチャを対象とする最適化Cコンパイラとして初めて、正当性の完全な機械的証明を達成。2021年ACMソフトウェアシステム賞を受賞。コンパイラの各変換パスが入力プログラムの意味を保存することをCoqで証明した。

### 6.5 その他の事例

- **Microsoft SLAM**: 静的解析と記号的モデル検査に基づくWindowsドライバの検証プラットフォーム
- **Microsoft SAGE**: ホワイトボックスファジングツール。Windows 7開発時のファイルファジングで発見されたバグの約3分の1を検出

## 7. 形式手法の課題と限界

### 7.1 スケーラビリティ

大規模システムへの適用における状態爆発問題は、モデル検査の根本的な課題である。定理証明においても、証明の複雑さがシステム規模に伴い急激に増大する。「スケールするのか」という問いに対する決定的な答えは未だ得られていない。

### 7.2 学習コスト

形式手法の習得には数学的素養と専門的訓練が必要であり、不利な学習曲線が産業普及の大きな障壁となっている。形式手法に関する持続的な偏見やステレオタイプ（実用性への懸念）も普及を妨げている。

### 7.3 仕様と実装のギャップ

形式仕様が正しくても、それが実装に正確に反映される保証は自明ではない。B Methodの段階的詳細化やCoqのプログラム抽出のように仕様から実装への変換を形式化するアプローチがあるが、完全なギャップの解消は依然として困難である。

### 7.4 コスト対効果

既存の開発ツールチェーンへの統合の困難さ、費用対効果への懸念が導入障壁となっている。形式手法の投資対効果は、エラーが重大な損害につながるセーフティクリティカルな領域でこそ正当化される。

## 8. 軽量形式手法の潮流

完全な形式検証のコストを回避しつつ、形式手法の利点を部分的に享受する「軽量形式手法（Lightweight Formal Methods）」が注目を集めている。

- **Alloy**: 有界モデル検査による軽量な設計探索の代表例。完全性は保証しないが、限定的なスコープ内で迅速に反例を発見する
- **TLA+のモデル検査**: 完全な定理証明ではなく、有限モデル検査による実用的な設計検証
- **契約プログラミング**: 事前条件・事後条件・不変条件をコード内に記述し、実行時に検査する（Design by Contract）
- **AIとの融合**: 大規模言語モデル（LLM）による形式仕様の自動生成や証明支援が研究されており、形式手法の敷居を下げる可能性がある。2024年以降、機械学習による検証フローの拡張に早期採用者が好意的な経験を報告している

学術界からは「適用可能な形式手法（Applicable Formal Methods）」、すなわち形式手法の専門知識がなくても産業専門家が使用でき、既存のビジネスプロセスに容易に統合できるツール群の構築が求められている。形式手法の実践的普及には、ツールの使いやすさと開発プロセスへの統合が鍵となる。
